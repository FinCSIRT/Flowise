version: '3.8'  # Changed from 3.1 for better compatibility

services:
  flowise:
    image: flowiseai/flowise:latest
    restart: unless-stopped  # Changed from always
    container_name: flowise
    networks:
      - dokploy-network  # ADD THIS
    expose:
      - 3000/tcp  # ADD THIS - Traefik needs this
    environment:
      - PORT=3000
      
      # ADD THESE REQUIRED AUTH VARIABLES:
      - FLOWISE_USERNAME=admin
      - FLOWISE_PASSWORD=4B5KJLNymLuYmNLhtdJE6ps8s1db8UMmsP
      
      # ADD THESE FOR PROPER CONFIG:
      - APP_URL=https://flowise.fincident.org
      - CORS_ORIGINS=https://flowise.fincident.org
      - TRUST_PROXY=true
      - SECURE_COOKIES=true

      # DATABASE
      - DATABASE_PATH=/root/.flowise
      # - DATABASE_TYPE=${DATABASE_TYPE}
      # - DATABASE_PORT=${DATABASE_PORT}
      # - DATABASE_HOST=${DATABASE_HOST}
      # - DATABASE_NAME=${DATABASE_NAME}
      # - DATABASE_USER=${DATABASE_USER}
      # - DATABASE_PASSWORD=${DATABASE_PASSWORD}
      # - DATABASE_SSL=${DATABASE_SSL}
      # - DATABASE_SSL_KEY_BASE64=${DATABASE_SSL_KEY_BASE64}

      # SECRET KEYS
      # - SECRETKEY_STORAGE_TYPE=${SECRETKEY_STORAGE_TYPE}
      - SECRETKEY_PATH=/root/.flowise
      # - FLOWISE_SECRETKEY_OVERWRITE=${FLOWISE_SECRETKEY_OVERWRITE}
      # - SECRETKEY_AWS_ACCESS_KEY=${SECRETKEY_AWS_ACCESS_KEY}
      # - SECRETKEY_AWS_SECRET_KEY=${SECRETKEY_AWS_SECRET_KEY}
      # - SECRETKEY_AWS_REGION=${SECRETKEY_AWS_REGION}
      # - SECRETKEY_AWS_NAME=${SECRETKEY_AWS_NAME}

      # LOGGING
      # - DEBUG=${DEBUG}
      - LOG_PATH=/root/.flowise/logs
      # - LOG_LEVEL=${LOG_LEVEL}
      # - LOG_SANITIZE_BODY_FIELDS=${LOG_SANITIZE_BODY_FIELDS}
      # - LOG_SANITIZE_HEADER_FIELDS=${LOG_SANITIZE_HEADER_FIELDS}

      # Remove other unnecessary environment variables for now

    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.flowise.rule=Host(`flowise.fincident.org`)"
      - "traefik.http.routers.flowise.entrypoints=websecure"
      - "traefik.http.routers.flowise.tls.certresolver=letsencrypt"
      - "traefik.http.services.flowise.loadbalancer.server.port=3000"
    
    healthcheck:
        test: ['CMD', 'curl', '-f', 'http://localhost:${PORT}/api/v1/ping']
        interval: 10s
        timeout: 5s
        retries: 5
        start_period: 30s
    
    volumes:
      - flowise-data:/root/.flowise  # CHANGED FROM BIND MOUNT
    
    entrypoint: /bin/sh -c "sleep 10; flowise start"  # Increased sleep

networks:
  dokploy-network:
    external: true
    name: dokploy-network

volumes:
  flowise-data:  # ADD THIS VOLUME DEFINITION
